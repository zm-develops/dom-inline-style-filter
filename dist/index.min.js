(function (global, factory) {
	typeof exports === 'object' && typeof module !== 'undefined' ? module.exports = factory() :
	typeof define === 'function' && define.amd ? define(factory) :
	(global = typeof globalThis !== 'undefined' ? globalThis : global || self, global.dominlinestylefilter = factory());
})(this, (function () { 'use strict';

	const contentElement=globalThis.document.body||globalThis.document.documentElement,cssBlockCommentRegex=/\/\*[^*]*\*+([^/*][^*]*\*+)*\//g;let removeDefaultStylesTimeoutId=null,tagNameDefaultStyles={};const blockStoppers=new Set(["address","article","aside","blockquote","details","dialog","dd","div","dl","dt","fieldset","figcaption","figure","footer","form","h1","h2","h3","h4","h5","h6","header","hgroup","hr","li","main","nav","ol","p","pre","section","svg","table","ul","math","ruby","svg","body","head","html"]),animationTimeKeys=["animation-duration","transition-duration"],boxModelOffsetKeys=["transform-origin","perspective-origin"],regressionPropertySet=new Set(["align-items","appearance","background-color","border","bottom","box-sizing","color","cursor","display","font-size","height","inset","interactivity","left","lettter-spacing","margin","max-height","max-width","min-height","min-width","opacity","overlay","outline","outline-offset","padding","perspective-origin","pointer-events","position","right","text-align","text-indent","text-spacing","text-underline","transform-origin","top","unicode-bidi","user-modify","user-select","vertical-align","visibility","white-space","width","word-spacing"]),dominlinestylefilter=function(e,t){(t=t||{}).debug="boolean"==typeof t.debug?t.debug:dominlinestylefilter.impl.options.debug,t.strict="boolean"==typeof t.strict?t.strict:dominlinestylefilter.impl.options.strict;const n=new Context(e,t);return new Promise(stageCloneWith(n)).then(collectTree).then(sortAscending).then(multiPassFilter).then(unstageClone).catch(unstageClone.bind(null,n))};var src=dominlinestylefilter;function Context(e,t){this.root=e,this.sibling=e.nextSibling,this.parent=e.parentElement,this.sandbox=null,this.self=null,this.tree=null,this.stack=[],this.pyramid=null,this.cutoff=null,this.depths=[],this.depth=null,this.declarations=null,this.bytes=null,this.delta=null,this.processed=[],this.options=t,this.options.debug="boolean"==typeof t.debug?t.debug:dominlinestylefilter.impl.options.debug,this.options.strict="boolean"==typeof t.strict?t.strict:dominlinestylefilter.impl.options.strict;}function Styles(e,t){this.context=e,this.element=t,this.inline=t.style,this.computed=e.self.getComputedStyle(t);}function execute(e){let t;return e((e=>{t=e;}),(e=>{throw new Error(e)})),t}dominlinestylefilter.sync=function(e,t){const n=new Context(e,t=t||{});try{let e=execute(stageCloneWith(n));return [collectTree,sortAscending,multiPassFilter,unstageClone].forEach((function(t){e=t(e);})),e}catch(e){unstageClone(n);}},dominlinestylefilter.impl={},dominlinestylefilter.impl.options={},dominlinestylefilter.impl.options.debug=!1,dominlinestylefilter.impl.options.strict=!1;const hashes=new Set;function createSandbox(){const e=globalThis.document.createElementNS("http://www.w3.org/1999/xhtml","iframe");let t=getRandomFourDigit();for(;hashes.has(t);)t=getRandomFourDigit();e.id="dominlinestylefilter-sandbox-"+t,hashes.add(t),e.style.visibility="hidden",e.style.position="fixed",e.style.width="100vw",e.style.height="100vh";const n=globalThis.document.characterSet||"UTF-8",o=globalThis.document.doctype,i=o?`<!DOCTYPE ${escapeHTML(o.name)} ${escapeHTML(o.publicId)} ${escapeHTML(o.systemId)}`.trim()+">":"";return contentElement.appendChild(e),tryTechniques(e,i,n,e.id)}function getRandomFourDigit(){return Math.floor(9e3*Math.random())+1e3}function escapeHTML(e){if(e){const t=globalThis.document.createElement("div");return t.innerText=e,t.innerHTML}return ""}function tryTechniques(e,t,n,o){try{return e.contentWindow.document.write(`${t}<html><head><meta charset='${n}'><title>${o}</title></head><body></body></html>`),e}catch(e){}const i=globalThis.document.createElement("meta");i.setAttribute("charset",n);try{const n=globalThis.document.implementation.createHTMLDocument(o);n.head.appendChild(i);const r=t+n.documentElement.outerHTML;return e.setAttribute("srcdoc",r),e}catch(e){}return e.contentDocument.head.appendChild(i),e.contentDocument.title=o,e}function stageCloneWith(e){return (t,n)=>{e.sandbox=createSandbox(),e.self=e.sandbox.contentWindow,e.self.document.body.appendChild(e.root),e.sandbox.parentElement||n("failed to append sandbox iframe to DOM"),t(e);}}function collectTree(e){const t=e.self.document.createTreeWalker(e.root,globalThis.NodeFilter.SHOW_ELEMENT);e.cutoff=e.depth=1,e.tree=[e.root],e.depths=[e.depth],e.stack=[],e.pyramid=[],e.declarations=e.root.style.length,e.bytes=e.root.style.cssText.length,e.processed=[!1];let n,o=0;for(;n=t.nextNode();){o+=1,e.tree.push(n);const t=getDepth.call(e,n,o);e.depths.push(t),e.declarations+=n.style.length,e.bytes+=n.style.cssText.length,e.processed.push(!1);}return e}function sortAscending(e){for(let t=e.cutoff;t>0;t--)for(let n=0;n<e.tree.length;n++)e.depths[n]===t&&e.pyramid.push(e.tree[n]);return e.tree=null,e}function getDepth(e,t){const n=this,o=n.tree[t-1]||null;if(e.parentElement===o)return n.depth+=1,n.stack.push(t-1),n.depth>n.cutoff&&(n.cutoff=n.depth),n.depth;if(e.previousElementSibling===o)return n.depth;for(let t=n.stack.length;t>=0;t--){const o=n.stack[t];if(n.tree[o]===e.parentElement){n.depth=n.depths[o]+1,n.stack=n.stack.slice(0,t+1);break}}return n.depth}function multiPassFilter(e){let t,n=0;for(e.pyramid.forEach(stripBlockComments),e.root.querySelectorAll("style").forEach(filterActiveMediaQueries),e.options.debug&&(t=debugFilterAuthorInlineStyles(e)),Math.round(Math.log2(e.declarations/e.pyramid.length))>=6&&(e.delta=0,e.pyramid.forEach(filterAuthorInlineStyles.bind(null,e)),e.options.debug&&debugFilterAuthorInlineStyles(e,t),e.delta=null),e.options.debug&&(t=debugFilterActiveInlineStyles(e,null,n));0!==e.delta;)e.delta=0,e.pyramid.forEach(filterActiveInlineStyles.bind(null,e)),e.options.debug&&(n+=1,debugFilterActiveInlineStyles(e,null,n));return e.options.debug&&debugFilterActiveInlineStyles(e,t),e}const roundTo3dp=e=>Math.round(1e3*e)/1e3;function debugFilterAuthorInlineStyles(e,t){if(!t)return console.info("filterAuthorInlineStyles"),console.info("context.pyramid.length",e.pyramid.length),console.info("context.declarations",e.declarations),console.info("context.bytes",e.bytes),performance.now();console.info("filterAuthorInlineStyles"),console.info("context.declarations",e.declarations),console.info("context.bytes",e.bytes),console.info("context.delta",e.delta),console.info("runtime(ms)",roundTo3dp(performance.now()-t));}function debugFilterActiveInlineStyles(e,t,n){if(0===n)return console.info("filterActiveInlineStyles"),console.info("context.declarations",e.declarations),console.info("context.bytes",e.bytes),performance.now();n?console.info("filterActiveInlineStyles","pass #"+n):(console.info("filterActiveInlineStyles"),console.info("runtime(ms)",roundTo3dp(performance.now()-t))),console.info("context.declarations",e.declarations),console.info("context.bytes",e.bytes),console.info("context.delta",e.delta);}function stripBlockComments(e){const t=e.getAttribute("style");cssBlockCommentRegex.test(t)&&e.setAttribute("style",t.replace(cssBlockCommentRegex,""));}function filterActiveMediaQueries(e){if(e.media&&!globalThis.matchMedia(e.media).matches)return void e.parentElement.removeChild(e);if(!e.textContent.includes("@media"))return;const t=/@media([^{]+)\{((?:(?!\}\s*\})[\s\S])*\})\s*\}/;let n;for(;n=t.exec(e.textContent);){const t=n[1].trim(),o=n[2].trim();globalThis.matchMedia(t).matches?e.textContent=e.textContent.replace(n[0],o):e.textContent=e.textContent.replace(n[0],"");}}function filterAuthorInlineStyles(e,t){if(!t.attributes.style)return;const n=new Styles(e,t),o=n.inline.cssText.length;e.bytes-=o,e.delta+=o;const i=cacheAuthorStyleRegressionGuard(n),r=freezeStyleAnimations(n),l=t!==e.root?e.self.getComputedStyle(t.parentElement):null,s=getDefaultStyle(e,t);tokenizeCssTextDeclarations(n.inline.cssText).map(getCssTextProperty).sort(compareHyphenCount).forEach(spliceAuthorCssStyleDeclaration.bind(null,n,l,s)),unfreezeStyleAnimations(n,r),applyAuthorStyleRegressionGuard(n,i);const a=n.inline.cssText.length;e.bytes+=a,e.delta-=o,""===t.getAttribute("style")&&t.removeAttribute("style");}function filterActiveInlineStyles(e,t,n){if(!t.attributes.style||!0===e.processed[n])return;const o=new Styles(e,t),i=o.inline.cssText.length;e.bytes-=i,e.delta+=i;const r=freezeStyleAnimations(o);handleBoxModelOrigins(o),"none"===o.inline.display?(e.declarations-=o.inline.length,o.inline.cssText="display: none;",e.declarations+=1):tokenizeCssTextDeclarations(o.inline.cssText).map(getCssTextProperty).sort(compareHyphenCount).forEach(spliceActiveCssTextDeclaration.bind(null,o)),unfreezeStyleAnimations(o,r);const l=o.inline.cssText.length;e.bytes+=l,e.delta-=l,l===i&&(e.processed[n]=!0),""===t.getAttribute("style")&&t.removeAttribute("style");}function freezeStyleAnimations(e){let t=!1,n=null;for(const o of animationTimeKeys){const i=e.inline.getPropertyValue(o);i&&(["auto","0s"].includes(i)?e.inline.removeProperty(o):(t=!0,n=n||{},n[o]=i,e.inline.setProperty(o,"0s")));}return t?n:void 0}function unfreezeStyleAnimations(e,t){if(t)for(const n in t)Object.prototype.hasOwnProperty.call(t,n)&&e.inline.setProperty(n,t[n]);}function handleBoxModelOrigins(e){for(const t of boxModelOffsetKeys){const n=e.inline.getPropertyValue(t),o=e.computed.getPropertyValue(t);if(!n)return;e.inline.removeProperty(t);const i=o.replace(/[0-9.]+/g,(function(e){return Math.round(1e4*parseFloat(e))/1e4}));e.computed.getPropertyValue(t)!==i&&e.inline.setPropertyValue(n);}}function cacheAuthorStyleRegressionGuard(e){for(const n of regressionPropertySet)e.inline.getPropertyValue(n);}function applyAuthorStyleRegressionGuard(e,t){for(const n of regressionPropertySet){e.inline.getPropertyValue("prop")!==t[n]&&e.inline.setPropertyValue(n,t[n]);}}function getDefaultStyle(e,t){const n=computeTagHierarchy(t),o=computeTagKey(n,e.options);if(tagNameDefaultStyles[o])return tagNameDefaultStyles[o];const i=constructElementHierachy(e.self.document,n),r=computeStyleForDefaults(e.self,i);return destroyElementHierarchy(i),tagNameDefaultStyles[o]=r,r}const isArrayDelimiter=(e,t,n)=>0===t||t===n.length-1;function computeTagKey(e,t){return !1===t.strict?e.filter(isArrayDelimiter).reverse().join(" ").toLowerCase():e.reverse().join(">").toLowerCase()}function computeTagHierarchy(e){const t=[e.tagName.toLowerCase()];if(blockStoppers.has(e.tagName.toLowerCase()))return t;let n=e;for(;n=n.parentNode;)if(n.nodeType===globalThis.Node.ELEMENT_NODE){const e=n.tagName.toLowerCase();if(t.push(e),blockStoppers.has(e))break}return t}function constructElementHierachy(e,t){let n=e.body;for(;t.length>0;){const o=t.pop(),i=e.createElement(o);n.appendChild(i),n=i;}return n.textContent="â€‹",n}function computeStyleForDefaults(e,t){const n={},o=e.getComputedStyle(t);return Array.from(o).forEach((function(e){n[e]="width"===e||"height"===e?"auto":o.getPropertyValue(e);})),n}function destroyElementHierarchy(e){let t=e,n=e.parentElement;for(;t&&"BODY"!==t.tagName;)n=t.parentElement,null!==n&&n.removeChild(t),t=n;}function tokenizeCssTextDeclarations(e){const t=[];let n=!1,o=0;for(let i=0;i<e.length;i++){const r=e.charAt(i);'"'!==r&&"'"!==r||(n=!n);const l=";"===r,s=i===e.length-1;if(!n&&(l||s)){const n=e.substring(o,s&&!l?i+1:i);t.push(n),o=i+1;}}return t}function getCssTextProperty(e){return e.slice(0,e.indexOf(":"))}function compareHyphenCount(e,t){const n=e=>/^--\b/.test(e),o=e=>/^-\b/.test(e);return n(e)&&!n(t)?1:!n(e)&&n(t)?-1:o(e)&&!o(t)?1:!o(e)&&o(t)?-1:t.split("-").length-e.split("-").length}function spliceAuthorCssStyleDeclaration(e,t,n,o){if("width"===o||"height"===o)return;if("transform-origin"===o||"perspective-origin"===o)return;if("animation-duration"===o||"transition-duration"===o)return;const i=e.inline.getPropertyValue(o),r=n[o],l=t?t.getPropertyValue(o):void 0;r&&i===r&&(!l||t&&i===l)&&(e.inline.removeProperty(o),e.context.declarations-=1);}function spliceActiveCssTextDeclaration(e,t){if("width"===t||"height"===t)return;if("transform-origin"===t||"perspective-origin"===t)return;if("animation-duration"===t||"transition-duration"===t)return;const n=e.inline.getPropertyValue(t),o=tokenizeCssTextDeclarations(e.inline.cssText),i=o.findIndex((e=>t===getCssTextProperty(e)));if(-1===i)return;e.inline.cssText=o.filter(((e,t)=>t!==i)).join("; ")+";";const r=""===n,l=n===e.computed.getPropertyValue(t);r||l?e.context.declarations-=1:e.inline.cssText=o.join("; ")+";";}function unstageClone(e){return e.parent&&e.parent.insertBefore(e.root,e.sibling),e.sandbox&&e.sandbox.parentElement&&contentElement.removeChild(e.sandbox),e.sandbox&&(e.self=null,e.sandbox=null),removeDefaultStylesTimeoutId&&clearTimeout(removeDefaultStylesTimeoutId),removeDefaultStylesTimeoutId=setTimeout((()=>{removeDefaultStylesTimeoutId=null,tagNameDefaultStyles={};}),2e4),e.root}

	return src;

}));
